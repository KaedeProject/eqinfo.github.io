<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="icon.jpg" type="image/jpeg">
    <title>eqinfo</title>
    <link rel="stylesheet" href="index.css">
    <script defer src="https://pyscript.net/alpha/pyscript.js"></script>
</head>
<body>
    <h1>🌍 最新の地震情報</h1>
    <div id="earthquake-info">
        <p>データ取得中...</p>
    </div>
    <footer>Developer By Kaede</footer>

    <script type="py-script">
        import js
        import asyncio
        import requests

        # 震度の変換マップ
        scale_dict = {
            10: "震度1", 20: "震度2", 30: "震度3", 40: "震度4",
            45: "震度5弱", 50: "震度5強", 55: "震度6弱",
            60: "震度6強", 70: "震度7"
        }

        async def fetch_earthquake_info():
            try:
                response = requests.get("https://api.p2pquake.net/v2/history?codes=551&limit=1")
                data = response.json()

                if not data:
                    js.document.getElementById("earthquake-info").innerHTML = "<p>地震情報が見つかりませんでした。</p>"
                    return
                
                latest_eq = data[0]
                hypo_name = latest_eq.get('earthquake', {}).get('hypocenter', {}).get('name', '情報なし')
                magnitude = latest_eq.get('earthquake', {}).get('hypocenter', {}).get('magnitude', '情報なし')
                max_scale = scale_dict.get(latest_eq.get('earthquake', {}).get('maxScale'), '情報なし')
                eq_time   = latest_eq.get('earthquake', {}).get('time', '情報なし')

                js.document.getElementById("earthquake-info").innerHTML = f"""
                    <p><strong>震源地:</strong> {hypo_name}</p>
                    <p><strong>マグニチュード:</strong> {magnitude}</p>
                    <p><strong>最大震度:</strong> {max_scale}</p>
                    <p><strong>発生日時:</strong> {eq_time}</p>
                """

            except Exception as e:
                js.console.error(f"エラー: {e}")
                js.document.getElementById("earthquake-info").innerHTML = "<p>データの取得に失敗しました。</p>"

        async def update_loop():
            while True:
                await asyncio.sleep(300)  # 300秒 = 5分
                await fetch_earthquake_info()

        # PyScript 側で関数を登録
        js.fetchEarthquakeInfo = fetch_earthquake_info
    </script>

    <script>
        async function updateEarthquakeInfo() {
            if (window.pyodide) {
                await pyodide.runPythonAsync('await fetchEarthquakeInfo()');
            }
        }

        updateEarthquakeInfo();

        setInterval(updateEarthquakeInfo, 300000);
    </script>
</body>
</html>