<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="icon.jpg" type="image/jpeg">
    <title>eqinfo</title>
    <link rel="stylesheet" href="index.css">
    <script defer src="https://pyscript.net/alpha/pyscript.js"></script>
</head>
<body>
    <h1>ğŸŒ æœ€æ–°ã®åœ°éœ‡æƒ…å ±</h1>
    <div id="earthquake-info">
        <p>ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</p>
    </div>
    <footer>Developer By Kaede</footer>

    <script type="py-script">
        import js
        import asyncio
        import requests

        # éœ‡åº¦ã®å¤‰æ›ãƒãƒƒãƒ—
        scale_dict = {
            10: "éœ‡åº¦1", 20: "éœ‡åº¦2", 30: "éœ‡åº¦3", 40: "éœ‡åº¦4",
            45: "éœ‡åº¦5å¼±", 50: "éœ‡åº¦5å¼·", 55: "éœ‡åº¦6å¼±",
            60: "éœ‡åº¦6å¼·", 70: "éœ‡åº¦7"
        }

        async def fetch_earthquake_info():
            try:
                response = requests.get("https://api.p2pquake.net/v2/history?codes=551&limit=1")
                data = response.json()

                if not data:
                    js.document.getElementById("earthquake-info").innerHTML = "<p>åœ°éœ‡æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>"
                    return
                
                latest_eq = data[0]
                hypo_name = latest_eq.get('earthquake', {}).get('hypocenter', {}).get('name', 'æƒ…å ±ãªã—')
                magnitude = latest_eq.get('earthquake', {}).get('hypocenter', {}).get('magnitude', 'æƒ…å ±ãªã—')
                max_scale = scale_dict.get(latest_eq.get('earthquake', {}).get('maxScale'), 'æƒ…å ±ãªã—')
                eq_time   = latest_eq.get('earthquake', {}).get('time', 'æƒ…å ±ãªã—')

                js.document.getElementById("earthquake-info").innerHTML = f"""
                    <p><strong>éœ‡æºåœ°:</strong> {hypo_name}</p>
                    <p><strong>ãƒã‚°ãƒ‹ãƒãƒ¥ãƒ¼ãƒ‰:</strong> {magnitude}</p>
                    <p><strong>æœ€å¤§éœ‡åº¦:</strong> {max_scale}</p>
                    <p><strong>ç™ºç”Ÿæ—¥æ™‚:</strong> {eq_time}</p>
                """

            except Exception as e:
                js.console.error(f"ã‚¨ãƒ©ãƒ¼: {e}")
                js.document.getElementById("earthquake-info").innerHTML = "<p>ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>"

        async def update_loop():
            while True:
                await asyncio.sleep(300)  # 300ç§’ = 5åˆ†
                await fetch_earthquake_info()

        # PyScript å´ã§é–¢æ•°ã‚’ç™»éŒ²
        js.fetchEarthquakeInfo = fetch_earthquake_info
    </script>

    <script>
        async function updateEarthquakeInfo() {
            if (window.pyodide) {
                await pyodide.runPythonAsync('await fetchEarthquakeInfo()');
            }
        }

        updateEarthquakeInfo();

        setInterval(updateEarthquakeInfo, 300000);
    </script>
</body>
</html>